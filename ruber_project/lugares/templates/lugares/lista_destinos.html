{% extends 'core/base.html' %}
{% load static %}

{% block title %}Explorar Destinos | Ruber{% endblock %}

{% block content %}
<div class="container py-5">
    
    <div class="text-center mb-5">
        <h6 class="text-primary fw-bold text-uppercase ls-2">Catálogo</h6>
        <h1 class="fw-bold display-5">Explora nuestros Destinos</h1>
        <p class="text-muted lead">Encuentra el lugar perfecto para tu próxima aventura en Perú.</p>
    </div>
    
    <div class="bg-white p-4 rounded-4 shadow-sm mb-5 border">
        <form method="get" class="row g-3 align-items-end">
            
            <div class="col-lg-4 col-md-6">
                <label class="form-label small text-muted fw-bold ms-2">Buscar</label>
                <div class="input-group">
                    <span class="input-group-text bg-light border-0 rounded-start-pill ps-3 text-primary">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" name="q" class="form-control bg-light border-0 rounded-end-pill py-2" 
                           placeholder="Nombre, lugar, experiencia..." value="{{ request.GET.q }}">
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <label class="form-label small text-muted fw-bold ms-2">Categoría</label>
                <select name="categoria" class="form-select bg-light border-0 rounded-pill py-2">
                    <option value="">Todas las categorías</option>
                    {% for cat in categorias %}
                    <option value="{{ cat.id }}" {% if request.GET.categoria == cat.id|stringformat:"s" %}selected{% endif %}>
                        {{ cat.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-lg-3 col-md-6">
                <label class="form-label small text-muted fw-bold ms-2">Ordenar por</label>
                <div class="input-group">
                    <select name="orden" class="form-select bg-light border-0 rounded-start-pill py-2">
                        <option value="nombre" {% if orden_actual == 'nombre' %}selected{% endif %}>Alfabético</option>
                        <option value="calificacion" {% if orden_actual == 'calificacion' %}selected{% endif %}>Calificación</option>
                        <option value="precio" {% if orden_actual == 'precio' %}selected{% endif %}>Precio</option>
                    </select>
                    <select name="dir" class="form-select bg-light border-0 border-start rounded-end-pill py-2" style="max-width: 80px;">
                        <option value="asc" {% if direccion_actual == 'asc' %}selected{% endif %}>Asc</option>
                        <option value="desc" {% if direccion_actual == 'desc' %}selected{% endif %}>Desc</option>
                    </select>
                </div>
            </div>

            <div class="col-lg-2 col-md-6">
                <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm">
                    Filtrar
                </button>
            </div>

            <div class="col-12 mt-3 border-top pt-3">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <span class="small text-muted"><i class="fas fa-info-circle me-1"></i> Usa los filtros para refinar tu búsqueda.</span>
                    
                    <div class="div-preferencias" style="min-width: 250px;">
                        {% if request.user.is_authenticated %}
                            {% if request.GET.preferencia == 'true' %}
                                {% with query_string=request.GET.urlencode|cut:'&preferencia=true'|cut:'preferencia=true' %}
                                <a href="?{{ query_string }}" class="btn btn-warning btn-sm rounded-pill px-3 fw-bold w-100">
                                    <i class="fas fa-times me-1"></i> Quitar Mis Preferencias
                                </a>
                                {% endwith %}
                            {% else %}
                                {% with query_string=request.GET.urlencode %}
                                <a href="?{{ query_string|default:"" }}&preferencia=true" class="btn btn-outline-success btn-sm rounded-pill px-3 fw-bold w-100">
                                    <i class="fas fa-magic me-1"></i> Filtrar por mis gustos
                                </a>
                                {% endwith %}
                            {% endif %}
                        {% else %}
                            <span class="badge bg-light text-muted border p-2 rounded-pill fw-normal">
                                <i class="fas fa-lock me-1"></i> Inicia sesión para filtrar por gustos
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <div class="row g-4">
        {% for destino in destinos %}
        <div class="col-lg-4 col-md-6">
            <div class="card h-100 border-0 shadow-sm rounded-4 overflow-hidden hover-up transition-all">
                
                <div class="position-relative">
                    {% if destino.imagen_principal %}
                        <img src="{{ destino.imagen_principal }}" class="card-img-top" alt="{{ destino.nombre }}" 
                             style="height: 220px; object-fit: cover;">
                    {% else %}
                        <div class="bg-light d-flex align-items-center justify-content-center text-muted" style="height: 220px;">
                            <i class="fas fa-image fa-3x opacity-25"></i>
                        </div>
                    {% endif %}
                    
                    <span class="position-absolute top-0 end-0 m-3 badge bg-white text-primary shadow-sm rounded-pill px-3 py-2 fw-bold">
                        {{ destino.categoria.nombre }}
                    </span>
                    {% if destino.costo_entrada > 0 %}
                    <span class="position-absolute bottom-0 start-0 m-3 badge bg-dark bg-opacity-75 text-white rounded-pill px-3 py-1 backdrop-blur">
                        S/ {{ destino.costo_entrada|floatformat:0 }}
                    </span>
                    {% else %}
                    <span class="position-absolute bottom-0 start-0 m-3 badge bg-dark bg-opacity-75 text-white rounded-pill px-3 py-1 backdrop-blur">
                        Libre
                    </span>
                    {% endif %}
                </div>

                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title fw-bold mb-0 text-dark">{{ destino.nombre }}</h5>
                        <div class="text-warning small fw-bold">
                            <i class="fas fa-star"></i> {{ destino.calificacion }}
                        </div>
                    </div>
                    
                    <p class="card-text text-muted small mb-3">
                        {{ destino.descripcion|truncatewords:18 }}
                    </p>
                    
                    <div class="d-flex align-items-center text-muted small mb-4">
                        <div class="me-3">
                            <i class="far fa-clock text-primary me-1"></i> {{ destino.tiempo_visita_estimado }} min
                        </div>
                        {% if destino.costo_entrada > 0 %}
                        <div>
                            <i class="fas fa-walking text-primary me-1"></i> Visita controlada
                        </div>
                        {% else %}
                        <div>
                            <i class="fas fa-walking text-primary me-1"></i> Visita libre
                        </div>
                        {% endif%}
                    </div>

                    <!-- BOTONES DE ACCIÓN -->
                    <div class="row g-2">
                        <div class="col-6">
                            <a href="{% url 'lugares:detalle_destino' destino.id %}" class="btn btn-outline-primary rounded-pill w-100 fw-bold btn-sm">
                                Ver Detalles
                            </a>
                        </div>
                        <div class="col-6">
                            {% if user.is_authenticated %}
                            <button type="button" class="btn btn-success rounded-pill w-100 fw-bold btn-sm"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#agregarModal{{ destino.id }}">
                                <i class="fas fa-plus"></i> Agregar
                            </button>
                            {% else %}
                            <a href="{% url 'usuarios:login' %}" class="btn btn-secondary rounded-pill w-100 fw-bold btn-sm">
                                <i class="fas fa-lock"></i> Iniciar
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MODAL PARA AGREGAR A ITINERARIO -->
        {% if user.is_authenticated %}
<div class="modal fade" id="agregarModal{{ destino.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> Agregar: {{ destino.nombre }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <!-- CORREGIDO: Usar la primera actividad disponible o crear acción especial -->
            {% with primera_actividad=destino.actividades.first %}
                {% if primera_actividad %}
                <form method="post" action="{% url 'itinerarios:agregar_actividad_manual' primera_actividad.id %}">
                    <div class="modal-body">
                        {% csrf_token %}
                        
                        <div class="alert alert-info small">
                            <i class="fas fa-info-circle"></i> 
                            Se agregará la actividad: <strong>{{ primera_actividad.nombre }}</strong>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Selecciona un Itinerario</label>
                            <!-- CORREGIDO: name="itinerario" -->
                            <select name="itinerario" class="form-select" required>
                                <option value="">-- Selecciona --</option>
                                {% for itinerario in user.itinerarios.all %}
                                    {% if itinerario.estado in 'borrador,confirmado' %}
                                    <option value="{{ itinerario.id }}">
                                        {{ itinerario.nombre }} ({{ itinerario.fecha_inicio|date:"d/m/Y" }})
                                    </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <small class="text-muted">Solo se muestran itinerarios activos</small>
                        </div>
                        
                        {% if user.itinerarios.count == 0 %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            No tienes itinerarios creados. 
                            <a href="{% url 'itinerarios:generar' %}" class="alert-link">Crea uno aquí</a>.
                        </div>
                        {% endif %}
                        
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="mb-2"><i class="fas fa-map-marker-alt text-success"></i> Información</h6>
                                <ul class="list-unstyled mb-0 small">
                                    <li><strong>Actividad:</strong> {{ primera_actividad.nombre }}</li>
                                    <li><strong>Costo:</strong> S/ {{ primera_actividad.costo }}</li>
                                    <li><strong>Duración:</strong> {{ primera_actividad.duracion_minutos }} min</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success" {% if user.itinerarios.count == 0 %}disabled{% endif %}>
                            <i class="fas fa-check"></i> Agregar al Itinerario
                        </button>
                    </div>
                </form>
                {% else %}
                <!-- Si no hay actividades, mostrar mensaje -->
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Este destino no tiene actividades disponibles.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
                {% endif %}
            {% endwith %}
        </div>
    </div>
</div>
{% endif %}
        
        {% empty %}
        <div class="col-12 text-center py-5">
            <div class="mb-3 text-muted opacity-50">
                <i class="fas fa-map-signs fa-4x"></i>
            </div>
            <h4 class="fw-bold text-muted">No encontramos destinos</h4>
            <p class="text-muted">Intenta ajustar los filtros o buscar con otros términos.</p>
            <a href="{% url 'lugares:lista_destinos' %}" class="btn btn-primary rounded-pill px-4 mt-2">
                Ver todos los destinos
            </a>
        </div>
        {% endfor %}
    </div>
</div>

<style>
    .hover-up {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .hover-up:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
    }
    .ls-2 { letter-spacing: 2px; }
    .backdrop-blur { backdrop-filter: blur(5px); }
</style>

{% endblock %}