{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ destino.nombre }} | Ruber{% endblock %}

{% block map %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block content %}

<style>
    :root {
        --cyan-dark: #00838F;
        --cyan-hover: #006064;
    }
    .text-cyan { color: var(--cyan-dark) !important; }
    .bg-cyan { background-color: var(--cyan-dark) !important; color: white; }
    .btn-cyan { 
        background-color: var(--cyan-dark); 
        color: white; 
        border: none; 
    }
    .btn-cyan:hover { 
        background-color: var(--cyan-hover); 
        color: white; 
        transform: translateY(-2px);
    }
    .ls-1 { letter-spacing: 1px; }
    .object-fit-cover { object-fit: cover; }
    .hover-up:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; }
    .transition-all { transition: all 0.3s ease; }
</style>

<div class="bg-white border-bottom py-3">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0 small">
                <li class="breadcrumb-item"><a href="{% url 'core:home' %}" class="text-muted">Inicio</a></li>
                <li class="breadcrumb-item"><a href="{% url 'lugares:lista_destinos' %}" class="text-muted">Destinos</a></li>
                <li class="breadcrumb-item active text-primary fw-bold" aria-current="page">{{ destino.nombre }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="position-relative bg-light" style="height: 500px; overflow: hidden;">
    {% if destino.imagen_principal %}
        <img src="{{ destino.imagen_principal }}" alt="{{ destino.nombre }}" 
             class="w-100 h-100 object-fit-cover" 
             style="object-position: center;">
    {% else %}
        <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-secondary bg-opacity-10">
            <i class="fas fa-image fa-5x text-muted opacity-25"></i>
        </div>
    {% endif %}
    
    <div class="position-absolute bottom-0 start-0 w-100 p-5" 
         style="background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);">
        <div class="container">
            <span class="badge bg-warning text-dark mb-2 rounded-pill px-3 fw-bold">
                {{ destino.categoria.nombre }}
            </span>
            <h1 class="display-3 fw-bold text-white mb-2">{{ destino.nombre }}</h1>
            <p class="text-white-50 lead mb-0">
                <i class="fas fa-map-marker-alt me-2 text-warning"></i> 
                {{ destino.direccion|default:"Ubicación en Perú" }}
            </p>
        </div>
    </div>
</div>

<div class="container py-5">
    <div class="row g-5">
        
        <div class="col-lg-8">
            
            <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
                <div class="mb-2">
                    {% if destino.tags_preferencias %}
                        {% for pref in destino.tags_preferencias %}
                            <span class="badge bg-light text-primary border rounded-pill px-3 py-2 me-1 mb-1">
                            <i class="fas fa-tags me-1"></i> {{ pref }}
                            </span>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="d-flex align-items-center bg-light px-3 py-2 rounded-pill">
                    <div class="text-warning me-2">
                        <i class="fas fa-star"></i>
                    </div>
                    <span class="fw-bold text-dark">{{ destino.calificacion }}</span>
                    <span class="text-muted small ms-1">/ 5.0</span>
                </div>
            </div>

            <div class="row g-3 mb-5 text-center">
                <div class="col-4">
                    <div class="p-3 border rounded-4 bg-white shadow-sm h-100">
                        <i class="fas fa-clock fa-2x text-primary mb-2 opacity-75"></i>
                        <p class="text-muted small mb-0 text-uppercase ls-1">Duración</p>
                        <h5 class="fw-bold mb-0">{{ destino.tiempo_visita_estimado }} min</h5>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-3 border rounded-4 bg-white shadow-sm h-100">
                        <i class="fas fa-wallet fa-2x text-cyan mb-2 opacity-75"></i>
                        {% if destino.costo_entrada > 0 %}
                        <p class="text-muted small mb-0 text-uppercase ls-1">Costo</p>
                        <h5 class="fw-bold mb-0">S/ {{ destino.costo_entrada|floatformat:0 }}</h5>
                        {% else %}
                        <p class="text-muted small mb-0 text-uppercase ls-1">Sin Costo</p>
                        <h5 class="fw-bold mb-0">Acceso Libre</h5>
                        {% endif %}
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-3 border rounded-4 bg-white shadow-sm h-100">
                        <i class="fas fa-camera fa-2x text-warning mb-2 opacity-75"></i>
                        <p class="text-muted small mb-0 text-uppercase ls-1">Tipo</p>
                        <h5 class="fw-bold mb-0">Turístico</h5>
                    </div>
                </div>
            </div>

            <div class="mb-5">
                <h3 class="fw-bold mb-3">Sobre este lugar</h3>
                <p class="text-muted lead" style="text-align: justify;">
                    {{ destino.descripcion }}
                </p>
            </div>

            <div class="mb-5">
    <h3 class="fw-bold mb-4">Actividades Disponibles</h3>
    {% if actividades %}
        <div class="d-flex flex-column gap-3">
            {% for actividad in actividades %}
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden hover-up transition-all mb-3">
                <div class="card-body p-4 d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="fw-bold mb-1">
                            {{ actividad.nombre }}
                            <span class="badge bg-info bg-opacity-10 text-info rounded-pill ms-2 small">
                                {{ actividad.get_tipo_display }}
                            </span>
                        </h5>
                        <p class="text-muted small mb-0">{{ actividad.descripcion|default:"Sin descripción" }}</p>
                        <div class="mt-2 text-muted small">
                            <i class="far fa-clock me-1"></i> {{ actividad.duracion_minutos }} min
                        </div>
                    </div>
                    
                    <div class="text-end ps-3 border-start">
                        <div class="fs-5 fw-bold text-cyan mb-1">S/ {{ actividad.costo }}</div>
                        
                        {% if user.is_authenticated %}
                            <button type="button" 
                                    class="btn btn-sm btn-outline-primary rounded-pill" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalActividad{{ actividad.id }}"
                                    title="Agregar a itinerario">
                                <i class="fas fa-plus"></i> Agregar
                            </button>
                        {% else %}
                            <a href="{% url 'usuarios:login' %}" class="btn btn-sm btn-outline-secondary rounded-pill">
                                <i class="fas fa-lock"></i>
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- MODAL CORREGIDO PARA CADA ACTIVIDAD -->
            {% if user.is_authenticated %}
            <div class="modal fade" id="modalActividad{{ actividad.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 border-0 shadow">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title fs-6 fw-bold">
                                <i class="fas fa-plus-circle me-2"></i> Agregar "{{ actividad.nombre }}"
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        
                        <!-- CORREGIDO: action y name del campo -->
                        <form action="{% url 'itinerarios:agregar_actividad_manual' actividad.id %}" method="post">
                            <div class="modal-body p-4">
                                {% csrf_token %}
                                
                                <div class="text-center mb-3">
                                    <div class="avatar bg-light text-primary rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                        <i class="fas fa-map-marked-alt fa-lg"></i>
                                    </div>
                                    <p class="small text-muted">Elige el itinerario donde deseas guardar esta actividad:</p>
                                </div>
                                <div class="text-end ps-3 border-start">
                                    {% if actividad.costo > 0 %}
                                    <div class="fs-5 fw-bold text-cyan mb-1">S/ {{ actividad.costo }}</div>
                                    {% else %}
                                    <div class="fs-5 fw-bold text-cyan mb-1">Actividad libre</div>
                                    {% endif %}
                                    <button class="btn btn-sm btn-outline-primary rounded-pill" data-bs-toggle="tooltip" title="Agregar a itinerario">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div> 

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Seleccionar Itinerario</label>
                                    <!-- CORREGIDO: usar 'itinerario' como name -->
                                    <select name="itinerario" class="form-select" required>
                                        <option value="">-- Selecciona un itinerario --</option>
                                        {% for it in user.itinerarios.all %}
                                            {% if it.estado in 'borrador,confirmado' %}
                                            <option value="{{ it.id }}">
                                                {{ it.nombre }} ({{ it.fecha_inicio|date:"d/m/Y" }})
                                            </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Info de la actividad -->
                                <div class="alert alert-light border">
                                    <h6 class="mb-2"><i class="fas fa-info-circle text-primary"></i> Detalles</h6>
                                    <ul class="list-unstyled mb-0 small">
                                        <li><strong>Destino:</strong> {{ actividad.destino.nombre }}</li>
                                        <li><strong>Costo:</strong> S/ {{ actividad.costo }}</li>
                                        <li><strong>Duración:</strong> {{ actividad.duracion_minutos }} min</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="modal-footer border-0 pt-0">
                                <button type="button" class="btn btn-link text-secondary text-decoration-none" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">
                                    Guardar Actividad
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-light border rounded-4 text-center py-4">
            <i class="fas fa-info-circle text-muted mb-2 fs-4"></i>
            <p class="text-muted mb-0">No hay actividades específicas registradas, pero la visita libre es increíble.</p>
        </div>
    {% endif %}
</div>

            {% if imagenes %}
            <div class="mb-5">
                <h3 class="fw-bold mb-4">Galería de Fotos</h3>
                <div class="row g-3">
                    {% for imagen in imagenes %}
                    <div class="col-md-4 col-6">
                        <a href="#" data-bs-toggle="modal" data-bs-target="#imagenModal{{ imagen.id }}">
                            <img src="{{ imagen.imagen.url }}" alt="Galería" 
                                 class="img-fluid rounded-4 shadow-sm w-100 object-fit-cover" 
                                 style="height: 180px; transition: transform 0.3s;"
                                 onmouseover="this.style.transform='scale(1.03)'" 
                                 onmouseout="this.style.transform='scale(1)'">
                        </a>
                        
                        <div class="modal fade" id="imagenModal{{ imagen.id }}" tabindex="-1">
                            <div class="modal-dialog modal-lg modal-dialog-centered">
                                <div class="modal-content bg-transparent border-0">
                                    <div class="modal-body p-0 text-center">
                                        <img src="{{ imagen.imagen.url }}" class="img-fluid rounded shadow-lg">
                                        {% if imagen.descripcion %}
                                        <p class="text-white mt-2">{{ imagen.descripcion }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <div class="sticky-top" style="top: 100px; z-index: 99;">
                
                <div class="card border-0 shadow rounded-4 mb-4 overflow-hidden">
                    <div class="card-header bg-cyan text-white p-3 border-0 text-center">
                        <h5 class="mb-0 fw-bold">¿Te gustaría ir aquí?</h5>
                    </div>
                    <div class="card-body p-4">
                        {% if user.is_authenticated %}
                            <button type="button" class="btn btn-warning w-100 rounded-pill fw-bold mb-3 py-2 shadow-sm"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#agregarDestinoModal">
                                <i class="fas fa-plus-circle me-2"></i> Agregar a mi Itinerario
                            </button>
                            
                            <a href="{% url 'rutas:mapa_rutas' %}?destino={{ destino.id }}" class="btn btn-outline-primary w-100 rounded-pill fw-bold py-2">
                                <i class="fas fa-route me-2"></i> Cómo llegar
                            </a>
                        {% else %}
                            <div class="text-center">
                                <p class="text-muted small mb-3">Inicia sesión para planificar tu viaje completo.</p>
                                <a href="{% url 'usuarios:login' %}" class="btn btn-primary w-100 rounded-pill fw-bold">
                                    Iniciar Sesión
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-body p-0 position-relative">
                        <div id="map" style="height: 250px; border-radius: 16px 16px 0 0;"></div>
                        <div class="p-3 bg-white border-top">
                            <h6 class="fw-bold mb-1">Ubicación</h6>
                            <p class="small text-muted mb-2">{{ destino.direccion|default:"Dirección referencial" }}</p>
                            <a href="https://www.google.com/maps/search/?api=1&query={{ destino.latitud }},{{ destino.longitud }}" 
                               target="_blank" class="small text-primary fw-bold text-decoration-none">
                                Ver en Google Maps <i class="fas fa-external-link-alt ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 bg-light">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3"><i class="fas fa-lightbulb text-warning me-2"></i>Tips de Viajero</h6>
                        <ul class="list-unstyled small text-muted mb-0">
                            <li class="mb-2"><i class="fas fa-check text-cyan me-2"></i>Mejor horario: Mañanas</li>
                            <li class="mb-2"><i class="fas fa-check text-cyan me-2"></i>Llevar ropa cómoda</li>
                            <li><i class="fas fa-check text-cyan me-2"></i>Cámara recomendada</li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

{% if user.is_authenticated and form_agregar %}
<div class="modal fade" id="agregarDestinoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> Agregar: {{ destino.nombre }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'itinerarios:agregar_actividad_manual' actividades.first.id|default:0 %}"> 
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="alert alert-info small">
                        <i class="fas fa-info-circle"></i> 
                        Se agregará la actividad principal de este destino.
                    </div>
                    <div class="mb-3">
                        {{ form_agregar.itinerario.label_tag }}
                        {{ form_agregar.itinerario }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-check"></i> Agregar al Itinerario
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% if recomendaciones %}
<div class="bg-light py-5 mt-5">
    <div class="container">
        <h3 class="fw-bold mb-4 text-center">También podría interesarte</h3>
        <div class="row g-4 justify-content-center">
            {% for destino_rec, peso, porcentaje in recomendaciones %}
            <div class="col-md-4 col-lg-3">
                <div class="card h-100 border-0 shadow-sm rounded-4 hover-up transition-all">
                    {% if destino_rec.imagen_principal %}
                    <img src="{{ destino_rec.imagen_principal }}" class="card-img-top rounded-top-4" style="height: 160px; object-fit: cover;">
                    {% else %}
                    <div class="bg-secondary bg-opacity-25 d-flex align-items-center justify-content-center rounded-top-4" style="height: 160px;">
                        <i class="fas fa-image text-muted fs-2"></i>
                    </div>
                    {% endif %}
                    
                    <div class="card-body p-3">
                        <h6 class="fw-bold mb-1">{{ destino_rec.nombre }}</h6>
                        <p class="text-muted small mb-3">{{ destino_rec.categoria.nombre }}</p>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between small mb-1">
                                <span class="text-muted" style="font-size: 0.8rem;">Coincidencia</span>
                                <span class="fw-bold text-cyan" style="font-size: 0.8rem;">{{ porcentaje }}%</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-cyan" role="progressbar" 
                                     style="width: {{ porcentaje }}%" 
                                     aria-valuenow="{{ porcentaje }}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                        </div>

                        <a href="{% url 'lugares:detalle_destino' destino_rec.id %}" class="btn btn-sm btn-outline-primary w-100 rounded-pill">
                            Ver detalles
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const lat = parseFloat("{{ destino.latitud|stringformat:'f' }}");
        const lng = parseFloat("{{ destino.longitud|stringformat:'f' }}");
        
        if (!isNaN(lat) && !isNaN(lng)) {
            const map = L.map('map', { 
                zoomControl: false, 
                scrollWheelZoom: false 
            }).setView([lat, lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);
            
            var redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            L.marker([lat, lng], {icon: redIcon}).addTo(map)
                .bindPopup('<b>{{ destino.nombre }}</b>')
                .openPopup();
        } else {
            console.error("Coordenadas no válidas");
            document.getElementById('map').innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted small">Sin ubicación</div>';
        }

        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });
</script>
{% endblock %}