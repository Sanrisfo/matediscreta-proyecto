{% extends 'core/base.html' %}

{% block title %}Mapa de Rutas - Ruber{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
    }
    /* Ocultar el panel lateral de texto del plugin de rutas */
    .leaflet-routing-container {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-5">
    <h1 class="text-center mb-4">Mapa de Rutas Turísticas</h1>
    
    <div class="row">
        <!-- Panel lateral -->
        <div class="col-md-3">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-filter"></i> Opciones</h5>
                </div>
                <div class="card-body">
                    <h6>Calcular Ruta Óptima</h6>
                    <form id="rutaForm">
                        <div class="mb-3">
                            <label class="form-label">Origen:</label>
                            <select class="form-select" id="origen">
                                <option value="">Seleccionar...</option>
                                {% for destino in destinos %}
                                <option value="{{ destino.id }}">{{ destino.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Destino:</label>
                            <select class="form-select" id="destino">
                                <option value="">Seleccionar...</option>
                                {% for destino in destinos %}
                                <option value="{{ destino.id }}">{{ destino.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-route"></i> Calcular Ruta
                        </button>
                    </form>
                    
                    <hr>
                    
                    <div id="resultadoRuta" class="alert alert-info d-none">
                        <h6>Resultado:</h6>
                        <p id="rutaInfo" class="mb-0"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mapa -->
        <div class="col-md-9">
            <div class="card shadow">
                <div class="card-body p-0">
                    <div id="map"></div>
                </div>
            </div>
            
            <div class="alert alert-warning mt-3">
                <i class="fas fa-info-circle"></i> 
                <strong>Nota:</strong> Usando Dijkstra en el servidor y OSRM en el cliente para trazar las calles.
            </div>
        </div>
    </div>
</div>

<!-- Insertar datos JSON de forma segura -->
{{ destinos_json|json_script:"destinos-data" }}
{{ rutas_json|json_script:"rutas-data" }}
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
    // Inicializar mapa
    const map = L.map('map').setView([-12.0464, -77.0428], 13); // Lima, Perú
    
    // Capa base de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Cargar datos de Django (JSON seguro)
    const destinos = JSON.parse(document.getElementById('destinos-data').textContent);
    const rutas = JSON.parse(document.getElementById('rutas-data').textContent);
    
    // Agregar marcadores
    const markers = {};
    destinos.forEach(destino => {
        const marker = L.marker([destino.latitud, destino.longitud])
            .bindPopup(`<strong>${destino.nombre}</strong>`)
            .addTo(map);
        markers[destino.id] = marker;
    });
    
    // Variable para guardar el control de rutas actual
    let routingControl = null;

    document.getElementById('rutaForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const origenId = document.getElementById('origen').value;
        const destinoId = document.getElementById('destino').value;

        const resultadoDiv = document.getElementById('resultadoRuta');
        const rutaInfo = document.getElementById('rutaInfo');
        
        if (origenId && destinoId) {
            resultadoDiv.classList.remove('d-none');
            rutaInfo.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Consultando grafo y trazando calles...';

            // 1. Consultar al backend (algoritmo Dijkstra en Python)
            fetch(`?origen=${origenId}&destino=${destinoId}`, {
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    rutaInfo.innerHTML = `
                        <strong><i class="fas fa-check-circle text-success"></i> Ruta Encontrada:</strong><br>
                        Distancia total (Grafo): <b>${data.distancia} km</b><br>
                        Camino: ${data.path.map(p => p.nombre).join(' <i class="fas fa-arrow-right small"></i> ')}
                    `;

                    // Eliminar ruta anterior si existe
                    if (routingControl) {
                        map.removeControl(routingControl);
                        routingControl = null;
                    }

                    // Crear puntos de paso desde el path del backend
                    const waypoints = data.path.map(p => L.latLng(p.lat, p.lng));

                    // 2. Usar Leaflet Routing Machine para trazar ruta calle por calle
                    routingControl = L.Routing.control({
                        waypoints: waypoints,
                        routeWhileDragging: false,
                        draggableWaypoints: false,
                        addWaypoints: false,
                        createMarker: function() { return null; },
                        lineOptions: {
                            styles: [{color: 'red', opacity: 0.8, weight: 6}]
                        }
                    }).addTo(map);

                } else {
                    rutaInfo.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle"></i> Error: ${data.error}</span>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                rutaInfo.innerHTML = '<span class="text-danger">Ocurrió un error al calcular la ruta.</span>';
            });
        }
    });
</script>
{% endblock %}
