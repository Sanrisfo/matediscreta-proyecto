{% extends 'core/base.html' %}
{% load static %}

{% block content %}

<div style="display: flex; width: 100%; height: 90vh;">
    
    <!-- Panel lateral -->
    <div style="width: 320px; padding: 15px; background: #f5f5f5; border-right: 1px solid #ccc; overflow-y: auto;">
        <h3>Rutas Tur칤sticas</h3>

        <label>Selecciona un destino:</label>
        <select id="destinoSelect" class="form-control mb-3">
            <option value="">-- Seleccione --</option>
            {% for d in destinos %}
            <option value="{{ d.id }}">{{ d.nombre }}</option>
            {% endfor %}
        </select>

        <button class="btn btn-primary mb-3" onclick="usarMiUbicacion()">游늸 Usar mi ubicaci칩n</button>

        <button class="btn btn-success mb-3" onclick="calcularRuta()">Calcular Ruta</button>

        <div id="infoRuta" style="margin-top: 15px; display:none;">
            <h4>Resultado</h4>
            <p><b>Distancia total:</b> <span id="distanciaTotal"></span> km</p>
        </div>

        <div id="errorBox" style="display:none; margin-top:10px;" class="alert alert-danger"></div>
    </div>

    <!-- Mapa -->
    <div id="map" style="flex: 1; height: 100%;"></div>

</div>


<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ==========================================
// VARIABLES GLOBALES
// ==========================================

let map;
let markerUsuario = null;
let rutaPolyline = null;
let miLat = null;
let miLng = null;

const destinos = JSON.parse(`{{ destinos_json|escapejs }}`);

//icono rojo del usuario
var redIcon = new L.Icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

// ==========================================
// INICIALIZAR MAPA
// ==========================================
document.addEventListener("DOMContentLoaded", () => {
    map = L.map('map').setView([-12.0464, -77.0428], 12);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18
    }).addTo(map);

    cargarMarcadoresDestinos();
});


// ==========================================
// MARCADORES DE DESTINOS
// ==========================================
function cargarMarcadoresDestinos() {
    destinos.forEach(dest => {
        L.marker([parseFloat(dest.latitud), parseFloat(dest.longitud)])
            .addTo(map)
            .bindPopup(`<b>${dest.nombre}</b>`);
    });
}


// ==========================================
// UBICACI칍N REAL DEL USUARIO
// ==========================================
function usarMiUbicacion() {
    // 1. Asignamos coordenadas de la universidad
    miLat = -12.0527479;
    miLng = -77.0858328;

    console.log("游늸 Usando ubicaci칩n fija:", miLat, miLng);

    // 2. Centramos el mapa en ese punto
    map.setView([miLat, miLng], 15);

    // 3. Si ya hab칤a un marcador, lo borramos para no duplicar
    if (markerUsuario) {
        map.removeLayer(markerUsuario);
    }

    // 4. Creamos el marcador en la posici칩n fija
    markerUsuario = L.marker([miLat, miLng], {
        draggable: true, //este draggable es lo que hace que se pueda mover
        icon: redIcon
    }).addTo(map)
      .bindPopup("<b>游늸 Mi Ubicaci칩n</b>")
      .openPopup();

    // 5. EVENTO EXTRA: Si arrastras el marcador, actualizamos las coordenadas
    // Esto te permitir치 probar rutas desde otros puntos cercanos sin cambiar el c칩digo
    markerUsuario.on('dragend', function(event) {
        var position = markerUsuario.getLatLng();
        miLat = position.lat;
        miLng = position.lng;
        console.log("Nueva posici칩n arrastrada:", miLat, miLng);
    });

    // 6. Limpiamos cualquier mensaje de error previo
    ocultarError();
}


// ==========================================
// CALCULAR RUTA (POST JSON)
// ==========================================
function calcularRuta() {

    const destinoId = document.getElementById("destinoSelect").value;

    if (!miLat || !miLng) {
        mostrarError("Debes usar tu ubicaci칩n antes de calcular una ruta.");
        return;
    }

    if (!destinoId) {
        mostrarError("Debes seleccionar un destino.");
        return;
    }

    const payload = {
        lat_origen: miLat,
        lng_origen: miLng,
        destino_id: parseInt(destinoId)
    };

    fetch("/rutas/mapa/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {

        if (!data.success) {
            mostrarError(data.error || "Error desconocido");
            return;
        }

        mostrarRutaEnMapa(data.ruta);
        mostrarInfoRuta(data.distancia_km);
    })
    .catch(err => {
        console.error(err);
        mostrarError("Error de conexi칩n.");
    });
}


// ==========================================
// MOSTRAR RUTA EN EL MAPA
// ==========================================
// Variable global para guardar la capa de la ruta y poder borrarla despu칠s
let rutaLayer = null; 

function mostrarRutaEnMapa(puntos) {
    // 1. Limpiar ruta anterior si existe
    if (rutaLayer) {
        map.removeLayer(rutaLayer);
    }

    // 2. Extraer coordenadas en formato: "longitud,latitud" (OSRM pide lon,lat)
    // 'puntos' es lo que te devuelve tu Django: [{lat:..., lng:...}, ...]
    const coordenadasString = puntos
        .map(p => `${p.lng},${p.lat}`)
        .join(";");

    // 3. Llamar a la API p칰blica de OSRM (Gratuita para proyectos peque침os)
    // profile puede ser: 'driving' (auto), 'walking' (caminar), 'cycling' (bici)
    const url = `https://router.project-osrm.org/route/v1/driving/${coordenadasString}?overview=full&geometries=geojson`;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            if (data.routes && data.routes.length > 0) {
                // OSRM nos devuelve la geometr칤a exacta de las calles
                const rutaGeometria = data.routes[0].geometry;

                // 4. Dibujar la ruta bonita sobre las calles
                rutaLayer = L.geoJSON(rutaGeometria, {
                    style: {
                        color: "blue",     // Color de la l칤nea
                        weight: 5,         // Grosor
                        opacity: 0.7       // Transparencia
                    }
                }).addTo(map);

                // 5. Ajustar el mapa para ver toda la ruta
                map.fitBounds(rutaLayer.getBounds());
            } else {
                console.error("No se pudo encontrar una ruta en las calles.");
            }
        })
        .catch(err => {
            console.error("Error conectando con OSRM:", err);
            // Fallback: Si falla OSRM, dibujamos la l칤nea recta fea original
            const coordsSimples = puntos.map(p => [p.lat, p.lng]);
            rutaLayer = L.polyline(coordsSimples, { color: 'red', dashArray: '5, 10' }).addTo(map);
        });
}


// ==========================================
// MOSTRAR INFO DE LA RUTA
// ==========================================
function mostrarInfoRuta(distancia) {
    document.getElementById("distanciaTotal").textContent = distancia;
    document.getElementById("infoRuta").style.display = "block";
    ocultarError();
}


// ==========================================
// MANEJO DE ERRORES
// ==========================================
function mostrarError(msg) {
    const box = document.getElementById("errorBox");
    box.style.display = "block";
    box.textContent = msg;
}

function ocultarError() {
    const box = document.getElementById("errorBox");
    box.style.display = "none";
}
</script>

{% endblock %}
